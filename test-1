---
- hosts: main
  become: True
  gather_facts: no
  remote_user: darius
  tasks:
          # create users for us
          # note user test1 added to sudo group
          # user in sudo or wheel group can sudo
          - user:
                  name: test1
                  comment: "Test One"
                  shell: /bin/bash
                  groups: sudo
                  append: yes
                  generate_ssh_key: yes
                  ## run command 'mkpasswd --method=sha-512' to create your own encrypted password ##
                  password: $6$0f3XPEFLxcLQFMl$ZjPX5jRb75KBeIkm0NxjDKzPjDXMZ7LcLcu/4lPi5vJA2DWz5zGLwAWO0ErI1n/mq6Wf65emHzuO4Icv5tMan1
                  ssh_key_type: rsa
          # upload ssh key
          - authorized_key:
                  user: test1
                  state: present
                  manage_dir: yes
                  key: "{{ lookup('file', '/Users/dariusbyckovskij/Ansible_stuff/id_test_1.pub') }}"
          # configure ssh server
          - template:
                  src: ssh-setup.j2
                  dest: /etc/ssh/sshd_config
                  owner: root
                  mode: '0600'
                  validate: /usr/sbin/sshd -t -f %s
                  backup: yes
          # restart sshd
          - service:
                  name: sshd
                  state: restarted
